option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: cardealer/wsgi.py
    NumProcesses: 1  # Reduced for t3.micro stability
    NumThreads: 4    # Optimal for low-memory instances
  aws:elasticbeanstalk:application:environment:
    DJANGO_SETTINGS_MODULE: recarnation.settings.production
    PYTHONPATH: /var/app/current:$PYTHONPATH

files:
  # Systemd service for Gunicorn (Amazon Linux 2023)
  "/etc/systemd/system/gunicorn.service":
    mode: "000644"
    owner: root
    group: root
    content: |
      [Unit]
      Description=Gunicorn server for Django
      After=network.target

      [Service]
      User=ec2-user
      Group=ec2-user
      WorkingDirectory=/var/app/current
      ExecStart=/usr/bin/gunicorn --bind 0.0.0.0:8000 cardealer.wsgi:application --workers 1 --threads 4 --timeout 120 --access-logfile - --error-logfile -
      Restart=always
      RestartSec=3
      Environment=DJANGO_SETTINGS_MODULE=recarnation.settings.production
      Environment=PYTHONPATH=/var/app/current

      [Install]
      WantedBy=multi-user.target

container_commands:
  01_reload_systemd:
    command: "sudo systemctl daemon-reload"
  02_enable_gunicorn:
    command: "sudo systemctl enable gunicorn"
  03_start_gunicorn:
    command: "sudo systemctl start gunicorn"

  # Ensure Nginx proxies to Gunicorn
  "/etc/nginx/conf.d/proxy.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      upstream django {
        server 127.0.0.1:8000;
        keepalive 32;
      }
