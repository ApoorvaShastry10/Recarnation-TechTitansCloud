# .ebextensions/01_main.config
packages:
  yum:
    python3: []
    python3-pip: []
    python3-devel: []
    gcc: []
    openssl-devel: []
    libffi-devel: []
    ca-certificates: []
    postgresql-devel: []  # Only if using PostgreSQL
    mysql-devel: []       # Only if using MySQL

commands:
  01_setup_environment:
    command: |
      mkdir -p /var/app/current
      chown -R webapp:webapp /var/app
      chmod -R 755 /var/app
      update-ca-trust

container_commands:
  01_install_dependencies:
    command: |
      #!/bin/bash
      set -xe
      
      # Find requirements.txt in common locations
      REQUIREMENTS_FILE=$(find /var/app \( -name "requirements.txt" -o -path "*/Recarnation-TechTitans/requirements.txt" \) -type f | head -1)
      
      if [ -z "$REQUIREMENTS_FILE" ]; then
        echo "ERROR: No requirements.txt found!"
        find /var/app -name "*.txt"
        exit 1
      fi
      
      echo "Installing from: $REQUIREMENTS_FILE"
      pip3 install --upgrade pip
      pip3 install --no-cache-dir -r "$REQUIREMENTS_FILE"

  99_force_move:
    command: |
      #!/bin/bash
      echo "Ensuring files are in /var/app/current"
      [ -d /var/app/staging ] && cp -R /var/app/staging/* /var/app/current/ || true
      chown -R webapp:webapp /var/app/current
    leader_only: false

option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: cardealer/wsgi.py
    NumProcesses: 1
    NumThreads: 4
    StaticFiles: /static/=static/
  aws:elasticbeanstalk:application:environment:
    DJANGO_SETTINGS_MODULE: cardealer.settings
    PYTHONPATH: /var/app/current:$PYTHONPATH

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_debug_verify.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      echo "=== FINAL DEPLOYMENT STATE ==="
      ls -la /var/app/current
      df -h
      echo "=== GUNICORN STATUS ==="
      systemctl status gunicorn || true
